<!DOCTYPE html>
<link
  rel="stylesheet"
  type="text/css"
  href="{{ url_for('static',filename='index.css') }}"
/>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Soccer Match Analysis</title>
  </head>
  <body>
    <div class="pitch-container">
      <div id="pitch" onClick="addShot(event)">
        <div class="goal left"></div>
        <div class="goal right"></div>
        <div class="center-circle"></div>
        <div class="center-spot"></div>
      </div>
    </div>
    <div class="button-group">
      <button class="event-button" onclick="setActionType.call(this, 'Shot');">
        Shot
      </button>
      <button
        class="event-button"
        onclick="setActionType.call(this, 'Shot-Save');"
      >
        Shot - Save
      </button>
      <button
        class="event-button"
        onclick="setActionType.call(this, 'Shot-Goal');"
      >
        Shot - Goal
      </button>
      <button
        class="event-button"
        onclick="setActionType.call(this, 'Shot Assist');"
      >
        Shot Assist
      </button>
      <button
        class="event-button"
        onclick="setActionType.call(this, 'Dribble');"
      >
        Dribble
      </button>
      <button class="event-button" onclick="setActionType.call(this, 'Cross');">
        Cross
      </button>
      <button class="event-button" onclick="setActionType.call(this, 'Pass');">
        Pass
      </button>
    </div>
    <script>
      function setActionType(actionType) {
        // Set the current action type
        currentActionType = actionType;

        // Get all action buttons
        var buttons = document.querySelectorAll(".event-button");

        // Remove the active class from all buttons
        buttons.forEach(function (button) {
          button.classList.remove("active");
        });
        // This assumes that this function is called with 'this' bound to the clicked button
        this.classList.add("active");
      }
      function setTeam(team) {
        // Set the current action type
        currentTeam = team;

        // Get all team buttons
        var buttons = document.querySelectorAll(".team-button");

        // Remove the active class from all buttons
        buttons.forEach(function (button) {
          button.classList.remove("active");
        });

        // Add the active class to the clicked button
        this.classList.add("active");
      }
    </script>
    <table id="event-table">
      <thead>
        <tr>
          <th>Player</th>
          <th>Event</th>
          <th>X1</th>
          <th>Y1</th>
          <th>xG</th>
          <th>xSave</th>
          <th>X</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be added here by JavaScript -->
      </tbody>
    </table>
    <script>
      var currentActionType = "Shot";
      var currentPlayer = "";
      var shotsData = [];

      function addShot(event) {
        var rect = event.target.getBoundingClientRect();
        var pitch = document.getElementById("pitch");
        var clickX = event.clientX - rect.left;
        var clickY = event.clientY - rect.top;
        if (event.target !== document.getElementById("pitch")) {
          clickX += event.target.offsetLeft;
          clickY += event.target.offsetTop;
        }
        dotX = clickX
        dotY = clickY
        var clickX = clickX / pitch.offsetWidth;
        var clickY = clickY / pitch.offsetHeight;
        // Normalize coordinates
        var x = Math.round(clickX * 105);
        var y = Math.round(clickY * 68);
        var actionType = currentActionType;
        var player = currentPlayer;
        var xG =
          actionType == "Shot" ||
          actionType == "Shot-Goal" ||
          actionType == "Shot-Save"
            ? distanceAnglexG(x, y)
            : "N/A";
        var xSave = actionType == "Shot-Save" ? +(1.0 - xG).toFixed(2) : "N/A";
        var table = document
          .getElementById("event-table")
          .getElementsByTagName("tbody")[0];
        var newRow = table.insertRow(table.rows.length);
        newRow.onmouseenter = function () {
          showDot(dotX, dotY);
        };
        newRow.onmouseleave = function () {
          removeDot();
        };
        var playerCell = newRow.insertCell(0);
        var actionCell = newRow.insertCell(1);
        var xCell = newRow.insertCell(2);
        var yCell = newRow.insertCell(3);
        var xgCell = newRow.insertCell(4); // Adjust the index if you have more columns
        var xSaveCell = newRow.insertCell(5); // Adjust the index if you have more columns
        var deleteCell = newRow.insertCell(6); // Adjust the index if you have more columns
        //Populate content
        playerCell.innerHTML = currentPlayer;
        actionCell.innerHTML = currentActionType;
        xCell.innerHTML = x;
        yCell.innerHTML = y;
        xgCell.innerHTML = xG;
        xSaveCell.innerHTML = xSave;
        var shotIndex = shotsData.length - 1;
        var deleteButton = document.createElement("button");
        deleteButton.textContent = "X";
        deleteButton.setAttribute("data-shot-index", shotIndex);
        deleteButton.onclick = function () {
          removeShot(this);
        };
        deleteCell.appendChild(deleteButton);
        shotsData.push({
          player: player,
          action: actionType,
          x: x,
          y: y,
          xG: xG,
          xSave: xSave,
        });
      }

      function removeShot(deleteButton) {
        // Retrieve the index of the shot from the delete button
        var shotIndex = parseInt(
          deleteButton.getAttribute("data-shot-index"),
          10
        );

        // Remove the shot from the shotsData array
        shotsData.splice(shotIndex, 1);

        // Remove the table row
        var row = deleteButton.parentNode.parentNode; // Assuming the button is within a cell of the row
        row.parentNode.removeChild(row);
      }

      function showDot(x, y) {
        // Convert the normalized x and y values to pixel positions on the pitch
        //var dotX = x / 105 * pitch.offsetWidth;
        //var dotY = y / 68 * pitch.offsetHeight;
    
        // Create the dot and position it
        var dot = document.createElement('div');
        dot.id = 'hover-dot'; // Assign an ID for easy removal
        dot.className = 'dot';
        dot.style.left = `${x}px`;
        dot.style.top = `${y}px`;
    
        pitch.appendChild(dot); 
      }

      function removeDot() {
        var dot = document.getElementById("hover-dot");
        if (dot) {
          dot.parentNode.removeChild(dot);
        }
      }

      function calculateDistance(pos_x, pos_y) {
        const midGoalX = 0.0;
        const midGoalY = 34.0;
        const goalCoordinates = [midGoalX, midGoalY];
        const shotCoordinates = [pos_x, pos_y];
        const distance = Math.hypot(
          shotCoordinates[0] - goalCoordinates[0],
          shotCoordinates[1] - goalCoordinates[1]
        );
        return distance;
      }

      function calculateAngle(pos_x, pos_y) {
        const deltaY = Math.pow(pos_y - 34.0, 2);
        const deltaX = Math.pow(pos_x - 0.0, 2);
        const radian = Math.atan2(deltaY, deltaX);
        const degrees = radian * (180 / Math.PI);
        return degrees;
      }
      function distanceAnglexG(pos_x, pos_y) {
        if (pos_x >= 52) {
          pos_x = 105 - pos_x;
          pos_y = 68 - pos_y;
        }
        let distance = calculateDistance(pos_x, pos_y);
        let angle = calculateAngle(pos_x, pos_y);
        // console.log("DISTANCE AND ANGLE");
        // console.log(distance, angle);
        let p =
          1 /
          (1 +
            Math.exp(
              -(
                0.2204 -
                0.0281 * pos_x -
                0.0062 * pos_y -
                0.0998 * distance -
                0.0081 * angle
              )
            ));
        // console.log("RAW VALUE");
        // console.log(p);
        // TODO: check if we output percentage or decimal
        // p = p*100;
        p = p.toFixed(2);
        // console.log(p);
        return p;
      }
    </script>
    <div class="button-group">
      <button id="download-csv" onclick="downloadCSV()">Download CSV</button>
    </div>
    <script>
      function downloadCSV() {
        fetch("/download_csv", {
          method: "POST",
          body: JSON.stringify(shotsData),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.blob())
          .then((blob) => {
            // Create a link element, use it to download the CSV file
            let url = window.URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            a.download = "shots_data.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
  </body>
</html>
